suite: HPA and Autoscaling Configuration Tests
templates:
  - hpa.yaml
  - rollout.yaml
  - poddisruptionbudget.yaml
tests:
  - it: should render HPA when autoscaling is enabled
    template: hpa.yaml
    set:
      autoscaling.enabled: true
    asserts:
      - isKind:
          of: HorizontalPodAutoscaler
      - isAPIVersion:
          of: autoscaling/v2
      - equal:
          path: metadata.name
          value: RELEASE-NAME-livecomments-hpa
      - equal:
          path: spec.scaleTargetRef.kind
          value: Rollout
      - equal:
          path: spec.scaleTargetRef.name
          value: RELEASE-NAME-livecomments

  - it: should configure HPA with min and max replicas
    template: hpa.yaml
    set:
      autoscaling.enabled: true
    asserts:
      - equal:
          path: spec.minReplicas
          value: 5
      - equal:
          path: spec.maxReplicas
          value: 100

  - it: should configure CPU utilization metric
    template: hpa.yaml
    set:
      autoscaling.enabled: true
    asserts:
      - contains:
          path: spec.metrics
          content:
            type: Resource
            resource:
              name: cpu
              target:
                type: Utilization
                averageUtilization: 33

  - it: should not configure external metrics by default
    template: hpa.yaml
    set:
      autoscaling.enabled: true
    asserts:
      - notContains:
          path: spec.metrics
          content:
            type: External

  - it: should configure external metrics when enabled
    template: hpa.yaml
    set:
      autoscaling.enabled: true
      autoscaling.externalMetrics.enabled: true
    asserts:
      - contains:
          path: spec.metrics
          content:
            type: External
            external:
              metric:
                name: base_connections_current
                selector:
                  matchLabels:
                    app.kubernetes.io/name: livecomments
                    app.kubernetes.io/instance: RELEASE-NAME
              target:
                type: AverageValue
                averageValue: null

  - it: should use custom external metric name
    template: hpa.yaml
    set:
      autoscaling.enabled: true
      autoscaling.externalMetrics.enabled: true
      autoscaling.externalMetrics.connectionMetricName: "custom_metric_name"
    asserts:
      - contains:
          path: spec.metrics
          content:
            type: External
            external:
              metric:
                name: custom_metric_name
                selector:
                  matchLabels:
                    app.kubernetes.io/instance: RELEASE-NAME
                    app.kubernetes.io/name: livecomments
              target:
                type: AverageValue
                averageValue: null

  - it: should not render HPA when autoscaling is disabled
    template: hpa.yaml
    set:
      autoscaling.enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should use static replica count when autoscaling is disabled
    template: rollout.yaml
    set:
      autoscaling.enabled: false
      replicaCount: 2
    asserts:
      - equal:
          path: spec.replicas
          value: 2

  - it: should not include replicas in rollout when autoscaling is enabled
    template: rollout.yaml
    set:
      autoscaling.enabled: true
    asserts:
      - isNull:
          path: spec.replicas

  - it: should render PodDisruptionBudget with correct configuration
    template: poddisruptionbudget.yaml
    asserts:
      - isKind:
          of: PodDisruptionBudget
      - equal:
          path: spec.maxUnavailable
          value: 1
      - equal:
          path: spec.selector.matchLabels["app.kubernetes.io/name"]
          value: livecomments

  - it: should configure custom max unavailable for PDB
    template: poddisruptionbudget.yaml
    set:
      podDisruptionBudget.maxUnavailable: 2
    asserts:
      - equal:
          path: spec.maxUnavailable
          value: 2

  - it: should configure custom min and max replicas
    template: hpa.yaml
    set:
      autoscaling.enabled: true
      autoscaling.minReplicas: 3
      autoscaling.maxReplicas: 10
    asserts:
      - equal:
          path: spec.minReplicas
          value: 3
      - equal:
          path: spec.maxReplicas
          value: 10

  - it: should match replica count with HPA min replicas
    template: rollout.yaml
    set:
      autoscaling.enabled: true
      autoscaling.minReplicas: 3
      replicaCount: 3
    asserts:
      - isNull:
          path: spec.replicas