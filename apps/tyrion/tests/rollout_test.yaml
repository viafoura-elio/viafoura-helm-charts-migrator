suite: Argo Rollouts Configuration Tests
templates:
  - rollout.yaml
  - istio-destinationrule.yaml
  - istio-virtualservice.yaml
  - rollout-preview-service.yaml
tests:
  - it: should configure canary deployment strategy by default
    template: rollout.yaml
    asserts:
      - isNotEmpty:
          path: spec.strategy.canary
      - equal:
          path: spec.strategy.canary.maxSurge
          value: "10%"

  - it: should include canary deployment steps
    template: rollout.yaml
    asserts:
      - isNotEmpty:
          path: spec.strategy.canary.steps
      - contains:
          path: spec.strategy.canary.steps
          content:
            setWeight: 5
      - contains:
          path: spec.strategy.canary.steps
          content:
            setWeight: 100

  - it: should configure Istio traffic routing for canary
    template: rollout.yaml
    asserts:
      - isNotEmpty:
          path: spec.strategy.canary.trafficRouting
      - equal:
          path: spec.strategy.canary.trafficRouting.istio.virtualService.name
          value: "RELEASE-NAME-tyrion-vs"
      - contains:
          path: spec.strategy.canary.trafficRouting.istio.virtualService.routes
          content: "primary"
      - equal:
          path: spec.strategy.canary.trafficRouting.istio.destinationRule.name
          value: "RELEASE-NAME-tyrion-dr"
      - equal:
          path: spec.strategy.canary.trafficRouting.istio.destinationRule.stableSubsetName
          value: "stable"
      - equal:
          path: spec.strategy.canary.trafficRouting.istio.destinationRule.canarySubsetName
          value: "canary"

  - it: should render destination rule for canary traffic routing
    template: istio-destinationrule.yaml
    asserts:
      - isKind:
          of: DestinationRule
      - isAPIVersion:
          of: networking.istio.io/v1
      - equal:
          path: spec.host
          value: RELEASE-NAME-tyrion.NAMESPACE.svc.cluster.local
      - equal:
          path: spec.subsets[0].name
          value: stable
      - equal:
          path: spec.subsets[1].name
          value: canary

  - it: should render virtual service for canary traffic routing
    template: istio-virtualservice.yaml
    asserts:
      - isKind:
          of: VirtualService
      - isAPIVersion:
          of: networking.istio.io/v1
      - contains:
          path: spec.hosts
          content: "tyrion.vf-dev2.org"
      - equal:
          path: spec.http[0].route[0].destination.subset
          value: stable
      - equal:
          path: spec.http[0].route[1].destination.subset
          value: canary

  - it: should not render destination rule when istio is disabled
    template: istio-destinationrule.yaml
    set:
      istio.enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should not render virtual service when canary is disabled
    template: istio-virtualservice.yaml
    set:
      rollout.strategy.canary.enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should configure blue-green deployment when enabled
    template: rollout.yaml
    set:
      rollout.strategy.blueGreen.enabled: true
      rollout.strategy.canary.enabled: false
    asserts:
      - isNotEmpty:
          path: spec.strategy.blueGreen
      - equal:
          path: spec.strategy.blueGreen.activeService
          value: tyrion
      - equal:
          path: spec.strategy.blueGreen.previewService
          value: tyrion-preview

  - it: should render preview service for blue-green deployment
    template: rollout-preview-service.yaml
    set:
      rollout.strategy.blueGreen.enabled: true
    asserts:
      - isKind:
          of: Service
      - equal:
          path: metadata.name
          value: RELEASE-NAME-tyrion-preview

  - it: should set revision history limit
    template: rollout.yaml
    asserts:
      - equal:
          path: spec.revisionHistoryLimit
          value: 10

  - it: should configure custom revision history limit
    template: rollout.yaml
    set:
      rollout.revisionHistoryLimit: 5
    asserts:
      - equal:
          path: spec.revisionHistoryLimit
          value: 5
