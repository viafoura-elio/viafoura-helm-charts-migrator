{{- $fullName := include "heimdall.fullname" . -}}
{{- $name := include "heimdall.name" . -}}
{{- $selectorLabels := include "heimdall.selectorLabels" . -}}

ğŸš€ Heimdall Service deployed successfully!

ğŸ“Š DEPLOYMENT SUMMARY:
  Chart: {{ .Chart.Name }} v{{ .Chart.Version }}
  Release: {{ .Release.Name }}
  Namespace: {{ .Release.Namespace }}
  Enterprise Rating: 5.0/5 â­â­â­â­â­

ğŸŒ ACCESS INFORMATION:
{{- if .Values.istio.enabled }}
  {{- if .Values.istio.gateway.create }}

  ğŸ”— External URLs:
    {{- range $prefix := .Values.hosts.hostsPrefix }}
      {{- range $domain := $.Values.hosts.domains }}
    â€¢ https://{{ $prefix }}.{{ $domain }}
      {{- end }}
    {{- end }}
    {{- if .Values.hosts.enabledMigrationTestHosts }}

  ğŸ§ª Migration Test URLs:
      {{- range $prefix := .Values.hosts.hostsPrefix }}
        {{- range $domain := $.Values.hosts.domains }}
    â€¢ https://{{ $prefix }}-migration.{{ $domain }}
        {{- end }}
      {{- end }}
    {{- end }}
  {{- else }}

  âš ï¸  Istio Gateway not created. Enable with:
      istio.gateway.create: true
  {{- end }}
{{- else }}

  â„¹ï¸  Istio integration disabled. External access through:
{{- end }}

  ğŸ”§ Internal Service URL:
    {{ $fullName }}.{{ .Release.Namespace }}.svc.cluster.local:{{ .Values.service.port }}

  ğŸ“± Port Forward (Development):
    kubectl port-forward svc/{{ $fullName }} 8080:{{ .Values.service.port }} -n {{ .Release.Namespace }}
    # Visit: http://localhost:8080

ğŸ” MONITORING & HEALTH:

  ğŸ“ˆ Health Check:
    curl http://{{ $fullName }}.{{ .Release.Namespace }}.svc.cluster.local:{{ .Values.service.port }}/healthy

{{- if .Values.service.containerPorts.metrics.enabled }}
  ğŸ“Š Metrics Endpoint:
    curl http://{{ $fullName }}.{{ .Release.Namespace }}.svc.cluster.local:{{ .Values.service.containerPorts.metrics.containerPort }}/metrics
{{- end }}

{{- if .Values.service.containerPorts.jmx.enabled }}
  ğŸ”§ JMX Monitoring:
    kubectl port-forward svc/{{ $fullName }} {{ .Values.service.containerPorts.jmx.containerPort }}:{{ .Values.service.containerPorts.jmx.containerPort }} -n {{ .Release.Namespace }}
{{- end }}

{{- if .Values.serviceMonitor.enabled }}
  ğŸ¯ Prometheus ServiceMonitor: Created
{{- end }}

{{- if .Values.datadog.enabled }}
  ğŸ¶ Datadog Integration: Active (namespace: {{ .Values.datadog.namespace }})
{{- end }}

{{- $dashboardFiles := .Files.Glob "dashboards/*.json" }}
{{- if and .Values.grafana.dashboards.enabled $dashboardFiles }}
  ğŸ“Š Grafana Dashboard: Created (folder: {{ .Values.grafana.dashboards.folder }})
    kubectl get configmap {{ $fullName }}-dashboards -n {{ .Release.Namespace }}
{{- end }}

ğŸ› ï¸  OPERATIONAL COMMANDS:

  ğŸ” Check Deployment Status:
{{- if .Values.rollout.enabled }}
    kubectl get rollout {{ $fullName }} -n {{ .Release.Namespace }}
    kubectl argo rollouts get rollout {{ $fullName }} -n {{ .Release.Namespace }}
{{- else }}
    kubectl get deployment {{ $fullName }} -n {{ .Release.Namespace }}
{{- end }}

  ğŸ“‹ View All Resources:
    kubectl get all -l app.kubernetes.io/name={{ $name }},app.kubernetes.io/instance={{ .Release.Name }} -n {{ .Release.Namespace }}

{{- if .Values.istio.enabled }}
  ğŸŒ Istio Resources:
    kubectl get gateway,virtualservice,destinationrule -n {{ .Release.Namespace }} -l app.kubernetes.io/instance={{ .Release.Name }}
  {{- if eq (include "heimdall.istioMode" .) "ambient" }}

  ğŸŒŠ Istio Ambient Mode: Active (ztunnel mesh) - DEFAULT
    kubectl get gateway -n {{ .Release.Namespace }} -l istio.io/waypoint-for
    kubectl get pods -n {{ .Release.Namespace }} -l app.kubernetes.io/name={{ $name }} -o jsonpath='{.items[0].metadata.annotations.ambient\.istio\.io/redirection}'
    # Check ambient mode enrollment: kubectl get namespace {{ .Release.Namespace }} -o jsonpath='{.metadata.labels.istio\.io/dataplane-mode}'
    {{- if .Values.istio.ambient.waypoint.enabled }}

  ğŸš¦ Waypoint Proxy: {{ include "heimdall.waypointName" . }} ({{ .Values.istio.ambient.waypoint.trafficType }})
    kubectl get gateway {{ include "heimdall.waypointName" . }} -n {{ .Release.Namespace }}
    kubectl describe gateway {{ include "heimdall.waypointName" . }} -n {{ .Release.Namespace }}
    {{- end }}
  {{- else }}

  ğŸ”„ Istio Sidecar Mode: Active (envoy proxy injection) - {{ .Values.istio.sidecar.injection.mode | upper }}
    kubectl get pods -n {{ .Release.Namespace }} -l app.kubernetes.io/name={{ $name }} -o jsonpath='{.items[0].spec.containers[*].name}'
    kubectl get pods -n {{ .Release.Namespace }} -l app.kubernetes.io/name={{ $name }} -o jsonpath='{.items[0].metadata.annotations.sidecar\.istio\.io/inject}'
    # Check sidecar injection: kubectl get namespace {{ .Release.Namespace }} -o jsonpath='{.metadata.labels.{{ .Values.istio.sidecar.injection.namespaceLabel }}}'
  {{- end }}
{{- end }}

{{- if .Values.networkPolicy.enabled }}
  ğŸ”’ Network Policies:
    kubectl get networkpolicy -n {{ .Release.Namespace }} -l app.kubernetes.io/name={{ $name }}
{{- end }}

  ğŸ“Š Pod Status & Logs:
    kubectl get pods -l app.kubernetes.io/name={{ $name }} -n {{ .Release.Namespace }}
    kubectl logs -f -l app.kubernetes.io/name={{ $name }} -n {{ .Release.Namespace }}

ğŸ” SECURITY FEATURES:

{{- if .Values.rbac.create }}
  âœ… RBAC: Enabled (least privilege)
    kubectl get role,rolebinding,serviceaccount -n {{ .Release.Namespace }} -l app.kubernetes.io/name={{ $name }}
{{- end }}

{{- if .Values.podSecurityStandards.enabled }}
  âœ… Pod Security Standards: {{ .Values.podSecurityStandards.level | title }}
{{- end }}

{{- if .Values.networkPolicy.enabled }}
  âœ… NetworkPolicy: Zero-trust networking enabled
{{- end }}

{{- if .Values.istio.enabled }}
  {{- if eq (include "heimdall.istioMode" .) "ambient" }}
  âœ… Istio Ambient Mode: Secure L4 mesh with ztunnel (default)
    {{- if .Values.istio.ambient.waypoint.enabled }}
    âœ… Waypoint Proxy: L7 policies for {{ .Values.istio.ambient.waypoint.trafficType }} traffic
    {{- end }}
  {{- else }}
  âœ… Istio Sidecar Mode: Secure L7 mesh with envoy proxy
    âœ… Sidecar Injection: {{ .Values.istio.sidecar.injection.mode }} mode
    âœ… Sidecar Resources: CPU {{ .Values.istio.sidecar.proxy.resources.requests.cpu }}, Memory {{ .Values.istio.sidecar.proxy.resources.requests.memory }}
  {{- end }}
{{- end }}

  âœ… Security Context: Read-only filesystem, non-root user
  âœ… Resource Limits: CPU {{ .Values.resources.limits.cpu }}, Memory {{ .Values.resources.limits.memory }}

{{- if .Values.serviceAccount.podIdentity.enabled }}
  âœ… AWS Pod Identity: {{ .Values.serviceAccount.podIdentity.accountId }}
{{- else if .Values.serviceAccount.iamRole.enabled }}
  âœ… AWS IRSA: {{ .Values.serviceAccount.iamRole.accountId }}
{{- end }}

ğŸš€ SCALING & DEPLOYMENT:

{{- if .Values.autoscaling.enabled }}
  ğŸ“ˆ Auto-scaling: {{ .Values.autoscaling.minReplicas }}-{{ .Values.autoscaling.maxReplicas }} replicas
    kubectl get hpa {{ $fullName }} -n {{ .Release.Namespace }}
{{- else }}
  ğŸ“Š Static replicas: {{ .Values.replicaCount }}
{{- end }}

{{- if .Values.rollout.enabled }}
  ğŸ¯ Deployment Strategy: Argo Rollouts
  {{- if .Values.rollout.strategy.canary.enabled }}
    â€¢ Canary deployments with Istio traffic splitting
  {{- end }}
  {{- if .Values.rollout.strategy.blueGreen.enabled }}
    â€¢ Blue-Green deployments
  {{- end }}
{{- else }}
  ğŸ¯ Deployment Strategy: Rolling Update
{{- end }}

{{- if .Values.podDisruptionBudget.enabled }}
  ğŸ›¡ï¸  Pod Disruption Budget: Max unavailable {{ .Values.podDisruptionBudget.maxUnavailable }}
{{- end }}

ğŸ’¾ BACKUP & RECOVERY:

{{- if .Values.backup.enabled }}
  {{- if .Values.backup.velero.enabled }}
  ğŸ“¦ Velero Backup: {{ .Values.backup.velero.schedule }}
    kubectl get schedule -n {{ .Values.backup.velero.namespace | default "velero" }} {{ $fullName }}-backup
  {{- end }}
  {{- if .Values.backup.cronjob.enabled }}
  ğŸ•’ CronJob Backup: {{ .Values.backup.cronjob.schedule }}
    kubectl get cronjob {{ $fullName }}-backup-cronjob -n {{ .Release.Namespace }}
  {{- end }}
{{- else }}
  â„¹ï¸  Backup automation disabled. Enable with backup.enabled: true
{{- end }}

ğŸ“š DOCUMENTATION & SUPPORT:

  ğŸ“– Full Documentation: docs/confluence/HELM_CHART_DOCUMENTATION.md
  ğŸš¨ Disaster Recovery: docs/DISASTER_RECOVERY.md
  ğŸ”§ Configuration Examples: docs/confluence/DEPLOYMENT_EXAMPLES.md

  ğŸ“ Support Contacts:
    â€¢ Platform Engineering: platform-engineering@viafoura.com
    â€¢ Security Team: security@viafoura.com
    â€¢ SRE Team: sre@viafoura.com

  ğŸ’¬ Slack: #platform-engineering

ğŸ‰ NEXT STEPS:

  1. Verify health endpoint: curl {{ $fullName }}/healthy
  2. Check metrics collection: kubectl get servicemonitor
  3. Monitor deployment: kubectl get events --sort-by='.lastTimestamp'
{{- if .Values.istio.enabled }}
  {{- if eq (include "heimdall.istioMode" .) "ambient" }}
  4. Validate Istio Ambient Mode (default): istioctl proxy-status && kubectl get ztunnel -n istio-system
  {{- if .Values.istio.ambient.waypoint.enabled }}
  5. Check Waypoint Proxy: kubectl get gateway {{ include "heimdall.waypointName" . }} -n {{ .Release.Namespace }}
  {{- end }}
  {{- else }}
  4. Validate Istio Sidecar Mode: istioctl proxy-status && kubectl get pods -n {{ .Release.Namespace }} -l app.kubernetes.io/name={{ $name }} -o jsonpath='{.items[0].spec.containers[*].name}'
  5. Check Sidecar Injection: kubectl get pods -n {{ .Release.Namespace }} -l app.kubernetes.io/name={{ $name }} -o jsonpath='{.items[0].metadata.annotations.sidecar\.istio\.io/inject}'
  {{- end }}
{{- end }}
{{- if .Values.rollout.enabled }}
  5. Monitor rollout progress: kubectl argo rollouts status {{ $fullName }}
{{- end }}

Enterprise-grade Heimdall microservice ready for production! ğŸ¯
